# Documentation

An in-depth explanation of how the bot works.

## Tiers

The bot is intended to play smogon doubles formats (particularly gen 8, in the past gen 7). The bot is not capable of playing VGC or singles formats. Given the importance of choosing your leads/which Pokemon you bring in VGC, and the current lack of logic in this area for the bot, it would likely not play so well without some improvements. In singles, the bot should be able to simulate multiple turns ahead due to the lower branching factor, but there are several problems. For one thing, the lack of long-term strategy, particularly around 'wincons' would be much more of a hinderance. The bot also uses a minimax algorithm, so it will assume the opponent plays the 'optimal' response to each move, meaning it thinks the opponent is equally as likely to make a 'safe' as a super risky one. Adjusting the bot mechanically to be able to play singles would also require more significant restructuring. Currently the bot uses gen 8 mechanics (e.g. recalculating move order mid-turn), making the bot store the gen of a battle and use it in determining how to simulate things should be simple and facilitate multi-gen support. Setting up the files to use for different formats rather than being hardcoded is something else on the to do list

## State Representation

Each battle is represented by a 'battle' object, containing information about the battle such as usernames, current weather/terrain conditions, entry hazards up, and most importantly, the Pokemon on each team. These are themselves represented by 'pokemon' objects, which store data such as types, stats, item, ability, moves, HP, and status.


### Unknown Information

Now, you should be thinking, you can certainly know all those things for Pokemon on your team, but for the opponent's Pokemon not so much. So how does the bot resolve this? The answer is usage stats. At the start of a battle, the bot will look up the Pokemon on the opponent's team in the ladder usage stats for the current tier to get an idea of the most likely movesets. First, I should mention the bot has a copy of the Pokedex used by Pokemon Showdown and will first use that to identify the types, base stats, and possible abilities of the given Pokemon. All possible abilities are considered, even if they are illegal or unlikely to be used, so in the future this should be taken from the usage stats. Now I just mentioned that multiple abilities are considered, which means that in a situation where the Pokemon is checked for having an ability, it will behave as if it simultaneously has all abilities at once. For example, an Excadrill will be considered to be receiving the speed boost from Sand Rush and be able to hit Rotom with Mold Breaker at the same time. Although that isn't completely the case, see next section. Similarly for other moveset aspects, illegally large combinations are considered so as to cover any possible situation. For moves, any move with a usage above a set alpha value (currently alpha=20%) are considered to be on the opponent's set. For some Pokemon with a very typical moveset, e.g. Incineroar in gen 7, this will simply mean it is considered to be running the four most common moves. On other Pokemon such as Dragapult, it will be considered to have a large moveset, containing moves run by both physical and special variants. Items are considered similarly, by assuming it is holding all items with a usage above the beta value (currently beta=10%). For EV spreads, the top spreads are considered and combined in a 'worst-case scenario' way, taking the highest value for each stat. For natures, if there is at least one nature in the most likely spreads boosting a stat, then it will be assumed to get the boost. The one exception is Speed, where the previous logic is first applied, but then if at least two of the most common spreads have a minus Speed nature then that will be applied instead (I don't think the same is done for Speed EVs though?).


### Known Information

Some information *is* revealed in battle, such as moves, or some items and abilities. If an item or ability is activated, then the respective Pokemon will be set to have only that item/ability. However, there is no logic for removing possible items/abilities when they are shown not to activate, e.g. no Mold Breaker/Intimidate message on entry or Sitrus Berry not activating when going below 50%.
Moves could be saved when seen, and logic applied to at least use the observed moves when they reach four instead of the usage moves, but currently nothing of the sort is done. There is also currently no logic for observing more subtle hints, such as using move/ability activation/residual damage/healing order to determine speeds or in particular check for Choice Scarf, or reverse engineering damage calcs to figure out the true spread.


## Battling Introduction

The bot uses the above information it knows to make decisions in battles. Most of the AI is focused on making decisions at the start of the turn, so I'll briefly discuss the other two types of decisions made first. One is choosing leads at the start of the battle. Given there are no Pokemon yet on the field, this is a very open-ended point in the battle, as each side has 15 (6C2) possible leads resulting in different turn 1 scenarios. Calculating ahead to each turn 1 would extremely computationally expensive, but I haven't yet figured out a cheaper, 'good enough' way of solving this problem. Currently, the bot will simply lead with the first two Pokemon on the team. The other situation is similar, in being forced switches, i.e. after a Pokemon faints or Volt Switch/U-turn are used. However there are usually going to be Pokemon on the field in this case, so there are not so many possibilities. Currently, an old heuristic is used comparing damage dealt to damage taken against active foes to decide the best Pokemon to choose. I believe when the opponent's Pokemon are both fainted this just does it by order of team again? It might be feasible to simulate the next turn for each possible switch for one degree of freedom (i.e. one switch is being made).

## Branching Factor

Important in the last section was the number of possible decisions at a given point in time for being able to effectively compute the best choice. This 'branching factor' as it is known as is massively important to the speed that a decision tree can be checked. In chess, the average branching factor is estimated to be ~30, meaning that a player will have roughly 30 moves available on each turn. For one complete turn, each player moving once, the number of different possible combinations is ~1000. This may surprise you, but in Pokemon (doubles at least), the branching factor is actually higher! In singles, you have 4 moves and upto 5 possible switches. Mega Evolution/Z-moves/Dynamax can potentially double the number of moves you have, giving 4x2+5=13 as an upper bound on the number of possible choices you can make at the start of a turn. Of course, the aforementioned mechanics are usually not available, and you won't always have a full team, so the average number is more likely ~7 possible choices each turn (for each player). In doubles, the branching factor is substantially higher. You may expect it to be simply double the previous number, but it is in fact more like being squared (i.e. instead of 7x2=14 it would be closer to 7^2=49). However, even this number is an underestimate! Rather than having just 4 moves available, the ability to select a target with most moves increases this factor. Take an Excadrill running a moveset of Iron Head, High Horsepower, Rock Slide, Protect. Now Protect and Rock Slide can't have a target selected, so those work as before. But for Iron Head and High Horsepower, there are 2 (3 if you include targeting your teammate) possibilities each! If we say you have an average of 3 switches available, then that gives you (2*1+2*2)+3=9 different possible choices for what to do with Excadrill. For a teammate with similar types of moves this gives 9^2=*81* possible choices for an average side in doubles. On a turn where you can Dynamax (i.e. have not dynamaxed yet but could) then this will be even higher. So looking at every possible combination of choices by both sides gives 81^2=6561 different ways a turn start out. One last thing to note is that because the bot assumes the opponent can have >4 moves, this number will be even higher in reality.

So given this massive number, we need to cut it down somehow to something more manageable. I've actually already mentioned a couple of ways how we can do that. For one, we can ignore attacking your teammate, as 98% of the time that's a bad move which can be dismissed. Another way is to ignore the possibility of Dynamaxing, which isn't a completely sensible thing to do but mostly reasonable. Not considering switching, or limiting it to only considering the top 1/2 possible switches is also an idea. But this still leaves a large number of possible move combinations left. The biggest way I've cut down on this is pruning the possible attacks into a few which are further simulated properly. Spread moves are all left in, but only the strongest single individual moves against each foe are considered. This substantially cuts down on the number of possible moves. With this, and all status moves currently ignored, a turn decision is made within a few seconds fairly accurately. Now obviously considering status moves *is* something that should be done, but a similar sort of pruning process can be applied. For example, not using Protect twice in a row or Tailwind when it's already up, and only using moves like Thunder-Wave if the target is not immune or already statused. An important thing to not about the pruning process used for attacks is that it falters in situations where the battle changing makes a different attack the stronger version. Intimidate/Snarl/Screens being set mid-turn will generally make no difference as they will affect all moves equally bar rare cases of mixed Pokemon, but otherwise those are fine. The main scenario where a change matters is with weather boosting/weakening the effect of Fire/Water moves, primarily coming from a switch to a Drought/Drizzle Pokemon. To an even lesser extent, terrain will also lead to problematic situations. As these are niche scenarios, and this method seems quite sound otherwise, this isn't currently a major concern.

## Simulation

Now, once we have a manageable set of possible turn choices, the next step is playing them out to see what happens. This is where the simulation part of the bot comes in, and is where most of the code in the near future will be added. Currently the setup is quite basic, really just going through moves in order and applying attack damage. This is done using a psuedo-calc covering the basic stats, typing, weather/terrain, and some abilities. Special effects of moves are not considered apart from literally just Facade. Moves can be reordered after each move (e.g. due to Tailwind), but since only damage is being simulated so far it doesn't change anything. Moves being retargeted by the target dying or redirection is not implemented. Moves by KOed foes being removed is implemented, however. All moves are assumed to hit, be a maximum roll, and not crit. Speed ties I haven't made it do anything with so IDK if it's currently doing it randomly or what.

## Minimax Algorithm

Now simulating a turn is one thing, but how do you actually interpret the result? This is where a state heuristic comes in. What this does is looks at the board state, and assigns some value based on how good or bad it is for the bot. In chess, a simple heuristic is looking at the 'material difference', where values are given to each type of piece and added up for each side, with the difference giving an indication to who is winning. More complicated versions give different values depending on where the pieces are located, as well as other techniques. But the foundation of the best algorithms used in chess and similar games is minimax. Minimax involves looking at a game tree, where two players take it in turns choosing a move (corresponding to a branch in the tree), and assumes the optimal move is chosen at each point. For a certain depth, the tree is stopped and evaluated using a heuristic for the end points, then propagates back up the tree using the minimax algorithm. This is what is used by the bot. Now in Pokemon, there are a number of factors not in chess, such as incomplete information, RNG, and most notably, simultaneous turns. This last point means that even if an opponent's move is 'optimal' in response to a given bot choice, it might actually be risky incase a different move is played. This is not considered by the bot, which assumes that the opponent can see it's move then choose the optimal response. Now beyond the basic minimax algorithm, a technique called alpha-beta pruning is used. This speeds up computation as some branches are not explored if there is already a better/worse option such that the result of the remaining node does not matter. Ordering the branches to be explored such that ones more likely to be good are explored first further speeds up this process, e.g. in chess considering captures or checks first. Currently the bot does not do any such ordering. Simulating each move against the opponent doing nothing (i.e. null-move pruning) could help.


## Pitfalls

As mentioned above, the bot is currently unable to consider status moves, which is the biggest step to take to increase its skill. Attacks' secondary/special effects are also not considered, but this is comparatively minor. Applying a set way of dealing with speed ties would also be a slight improvement. Being able to simulate two turns ahead in a reasonable time would be a goal for the future, as that would aid the bot in seeing the utility of status moves, but focusing on getting things working properly for one turn first is the priority. A somewhat noticeable downside to the strongest move pruning used, aside from the weather scenario discussed above, is the case of inaccurate moves. Often, Rotom-W will Hydro Pump something that is at like 10% risking a miss. Repeatedly calcing identical/similar attacks across different simulations takes time and an attempt to reduce this should be investigated. Early exit of the calc function for attacks doing zero damage would also provide a minor speedup in some cases. Another more major problem with the bot is that the minimax algorithm means that sometimes the bot makes a silly move because it assumes it will be KOed so it won't make a difference.
